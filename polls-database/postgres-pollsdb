CREATE DATABASE  poll ;

CREATE SEQUENCE poll.user_seq;

CREATE TABLE poll.user (
  id BIGINT NOT NULL DEFAULT NEXTVAL ('poll.user_seq'),
  firstName VARCHAR(50) NULL DEFAULT NULL,
  lastName VARCHAR(50) NULL DEFAULT NULL,
  email VARCHAR(50) NULL,
  passwordHash VARCHAR(32) NOT NULL,
  host SMALLINT NOT NULL DEFAULT 0,
  registeredAt TIMESTAMP(0) NOT NULL,
  lastLogin TIMESTAMP(0) NULL DEFAULT NULL,
  intro TINYTEXT NULL DEFAULT NULL,
  displayName TEXT NULL DEFAULT NULL,
  PRIMARY KEY (id));

CREATE SEQUENCE poll.poll_seq;

CREATE TABLE poll.poll (
  id BIGINT NOT NULL DEFAULT NEXTVAL ('poll.poll_seq'),
  surveyHostId BIGINT NOT NULL,
  title VARCHAR(75) NOT NULL,
  metaTitle VARCHAR(100) NULL,
  summary TINYTEXT NULL,
  type SMALLINT NOT NULL DEFAULT 0,
  published SMALLINT NOT NULL DEFAULT 0,
  createdAt TIMESTAMP(0) NOT NULL,
  updatedAt TIMESTAMP(0) NULL DEFAULT NULL,
  publishedAt TIMESTAMP(0) NULL DEFAULT NULL,
  startsAt TIMESTAMP(0) NULL DEFAULT NULL,
  endsAt TIMESTAMP(0) NULL DEFAULT NULL,
  content TEXT NULL DEFAULT NULL,
  PRIMARY KEY (id),
  CONSTRAINT fk_poll_host
    FOREIGN KEY (surveyHostId)
    REFERENCES poll.user (id)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE SEQUENCE poll.poll_meta_seq;

CREATE TABLE poll.poll_meta (
  id BIGINT NOT NULL DEFAULT NEXTVAL ('poll.poll_meta_seq'),
  pollId BIGINT NOT NULL,
  key VARCHAR(50) NOT NULL,
  content TEXT NULL DEFAULT NULL,
  PRIMARY KEY (id)
 ,
  CONSTRAINT uq_poll_meta UNIQUE (pollId, key),
  CONSTRAINT fk_meta_poll
    FOREIGN KEY (pollId)
    REFERENCES poll.poll (id)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE INDEX idx_meta_poll ON poll.poll_meta (pollId ASC);


CREATE SEQUENCE poll.poll_question_seq;

CREATE TABLE poll.poll_question (
  id BIGINT NOT NULL DEFAULT NEXTVAL ('poll.poll_question_seq'),
  pollId BIGINT NOT NULL,
  type VARCHAR(50) NOT NULL,
  active SMALLINT NOT NULL DEFAULT 0,
  createdAt TIMESTAMP(0) NOT NULL,
  updatedAt TIMESTAMP(0) NULL DEFAULT NULL,
  content TEXT NULL DEFAULT NULL,
  PRIMARY KEY (id)
 ,
  CONSTRAINT fk_question_poll
    FOREIGN KEY (pollId)
    REFERENCES poll.poll (id)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE INDEX idx_question_poll ON poll.poll_question (pollId ASC);

CREATE SEQUENCE poll.poll_answer_seq;

CREATE TABLE poll.poll_answer (
  id BIGINT NOT NULL DEFAULT NEXTVAL ('poll.poll_answer_seq'),
  pollId BIGINT NOT NULL,
  questionId BIGINT NOT NULL,
  active SMALLINT NOT NULL DEFAULT 0,
  createdAt TIMESTAMP(0) NOT NULL,
  updatedAt TIMESTAMP(0) NULL DEFAULT NULL,
  content TEXT NULL DEFAULT NULL,
  PRIMARY KEY (id)
 ,
  CONSTRAINT fk_answer_poll
    FOREIGN KEY (pollId)
    REFERENCES poll.poll (id)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE INDEX idx_answer_poll ON poll.poll_answer (pollId ASC);

ALTER TABLE poll.poll_answer 
ADD CREATE INDEX idx_answer_question ON poll.poll_answer (questionId ASC);
ALTER TABLE poll.poll_answer 
ADD CONSTRAINT fk_answer_question
  FOREIGN KEY (questionId)
  REFERENCES poll.poll_question (id)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
